<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Praxis App – Befund + Honorarnote + Backup</title>
  <style>
    :root{
      --bg:#0b1020; --card:#0f172a; --muted:#94a3b8; --text:#e5e7eb;
      --border:#1f2a44; --accent:#2563eb; --ok:#10b981; --danger:#ef4444;
      --chip:#111c35;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:rgba(15,23,42,.92);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1150px;margin:0 auto;padding:14px 16px}
    .titlebar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-size:16px}
    .pill{font-size:12px;color:#cbd5e1;background:var(--chip);border:1px solid #223055;border-radius:999px;padding:6px 10px}
    main{max-width:1150px;margin:0 auto;padding:16px;display:grid;gap:14px}
    .grid{display:grid;gap:14px}
    @media (min-width: 920px){.grid{grid-template-columns: 360px 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:12px}
    .card h2{margin:0 0 10px 0;font-size:14px;color:#cbd5e1}
    .row{display:grid;gap:10px}
    label{display:grid;gap:6px;font-size:12px;color:#cbd5e1}
    input, textarea, select{
      width:100%;border-radius:14px;border:1px solid #223055;background:#0b1020;color:var(--text);
      padding:10px 12px;outline:none
    }
    textarea{min-height:92px;resize:vertical}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .btns{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{border:0;border-radius:14px;padding:10px 12px;font-weight:800;color:white;background:var(--accent);cursor:pointer}
    button.secondary{background:#334155}
    button.ghost{background:transparent;border:1px solid #314264;color:#cbd5e1}
    button.danger{background:var(--danger)}
    button:disabled{opacity:.5;cursor:not-allowed}
    .muted{color:var(--muted);font-size:12px}
    .status{font-size:12px;color:var(--ok)}
    .status.bad{color:#fecaca}
    .cases{display:grid;gap:10px}
    .caseItem{display:grid;gap:6px;padding:10px;border-radius:16px;border:1px solid #223055;background:#0b1020}
    .caseItem strong{font-size:13px}
    .caseMeta{font-size:12px;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap}
    .hr{height:1px;background:var(--border);margin:10px 0}
    .two{display:grid;gap:10px}
    @media (min-width: 920px){.two{grid-template-columns: 1fr 1fr}}
    details{border:1px solid #223055;border-radius:16px;background:#0b1020;padding:10px}
    summary{cursor:pointer;font-weight:900;color:#cbd5e1}
    .printOnly{display:none}
    @media print{
      header,.noPrint{display:none !important}
      body{background:white;color:black}
      .card{border:1px solid #ddd;background:white}
      input,textarea,select{border:1px solid #ccc;background:white;color:black}
      details{border:none;background:white;padding:0}
      .printOnly{display:block}
    }
  
    .lockOverlay{position:fixed;inset:0;background:rgba(3,7,18,.78);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;z-index:9999;padding:18px}
    .lockCard{width:min(520px,100%);background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px}
    .lockTitle{font-weight:900;font-size:16px}
    .lockSub{margin-top:6px;color:var(--muted);font-size:12px}
    .lockBtn{margin-top:12px;width:100%;border:0;border-radius:14px;padding:10px 12px;font-weight:900;color:white;background:var(--accent);cursor:pointer}
    .lockError{margin-top:10px;color:#fecaca;font-size:12px}
    .lockHint{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.35}

  </style>
</head>
<body>

<div id="lockOverlay" class="lockOverlay" style="display:none">
  <div class="lockCard">
    <div class="lockTitle">Praxis App – gesperrt</div>
    <div class="lockSub">Bitte PIN eingeben, um fortzufahren.</div>

    <div id="lockCreate" style="display:none">
      <label style="display:grid;gap:6px;font-size:12px;color:#cbd5e1;margin-top:10px">Neuen PIN setzen
        <input id="pinNew1" inputmode="numeric" autocomplete="new-password" maxlength="12" placeholder="PIN (z.B. 6-stellig)"/>
      </label>
      <label style="display:grid;gap:6px;font-size:12px;color:#cbd5e1;margin-top:10px">PIN wiederholen
        <input id="pinNew2" inputmode="numeric" autocomplete="new-password" maxlength="12" placeholder="PIN erneut eingeben"/>
      </label>
      <button id="btnSetPin" class="lockBtn" type="button">PIN speichern</button>
      <div class="lockHint">Hinweis: Der PIN schützt nur diese App auf diesem Gerät/Browser. Ohne Cloud/Server kann ein technisch versierter Zugriff auf das Gerät trotzdem Daten auslesen.</div>
    </div>

    <div id="lockEnter" style="display:none">
      <label style="display:grid;gap:6px;font-size:12px;color:#cbd5e1;margin-top:10px">PIN
        <input id="pinEnter" inputmode="numeric" autocomplete="current-password" maxlength="12" placeholder="PIN eingeben"/>
      </label>
      <button id="btnUnlock" class="lockBtn" type="button">Entsperren</button>
      <div id="lockError" class="lockError" style="display:none"></div>
    </div>
  </div>
</div>

<header>
  <div class="wrap titlebar">
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <h1>Praxis App</h1>
      <span class="pill">Befund • Honorarnote • Backup</span>
      <span id="storageStatus" class="status">Lokal gespeichert ✓</span>
    </div>
    <div class="btns noPrint">
      <button id="btnNew" class="secondary">Neuer Fall</button>
      <button id="btnSave">Fall speichern</button>
      <button id="btnPrint" class="secondary">PDF/Print</button>
      <button id="btnLock" class="ghost">Sperren</button>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card noPrint">
      <h2>Fälle</h2>
      <div class="row">
        <label>Suche
          <input id="search" placeholder="Name / Datum / Stichwort…" />
        </label>

        <div class="toolbar">
          <span class="muted">Backup = komplette Daten (Fälle + Rechnungscounter + Profil).</span>
          <div class="btns">
            <button id="btnBackup" class="ghost">Backup exportieren</button>
            <button id="btnRestore" class="ghost">Backup wiederherstellen</button>
            <input id="restoreFile" type="file" accept="application/json" style="display:none"/>
            <button id="btnDeleteAll" class="danger">Alles löschen</button>
          </div>
        </div>

        <div class="cases" id="caseList"></div>
        <p class="muted" id="empty" style="display:none">Noch keine Fälle.</p>
      </div>
    </section>

    <section class="card">
      <div class="printOnly">
        <h2>Befund / Honorarnote (Ausdruck)</h2>
        <p style="font-size:12px">Erstellt mit der Praxis App (lokal/offline).</p>
      </div>

      <div class="toolbar">
        <h2>Aktueller Fall</h2>
        <div class="btns noPrint">
          <button id="btnCopy" class="ghost">Text kopieren</button>
          <button id="btnDelete" class="danger">Fall löschen</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="two">
        <div class="row">
          <label>Klient:in / Name
            <input id="clientName" placeholder="z.B. Frau G., Herr R."/>
          </label>
          <label>Geburtsdatum (optional)
            <input id="dob" placeholder="TT.MM.JJJJ"/>
          </label>
          <label>Datum
            <input id="date" type="date"/>
          </label>
          <label>Setting / Kontext
            <input id="setting" placeholder="z.B. WG, Tagesstruktur, Ambulanz…"/>
          </label>
        </div>

        <div class="row">
          <label>Fragestellung / Anlass
            <textarea id="question"></textarea>
          </label>
          <label>Methoden (Kurz)
            <textarea id="methods" placeholder="Exploration, Verhaltensbeobachtung, Testverfahren…"></textarea>
          </label>
        </div>
      </div>

      <div class="hr"></div>

      <div class="two">
        <div class="row">
          <label>DSDS (Werte)
            <textarea id="dsds" placeholder="z.B. E=5, M=3, L=1, VL=0, CCS=3; Stadium: Frühes Stadium…"></textarea>
          </label>
          <label>DTIM (Werte)
            <textarea id="dtim" placeholder="z.B. Orientierung 9/9, Planen & Handeln 14/20…"></textarea>
          </label>
        </div>
        <div class="row">
          <label>Zusammenfassung
            <textarea id="summary" placeholder="Kurz und klinisch."></textarea>
          </label>
          <label>Empfehlungen
            <textarea id="reco" placeholder="Konkrete nächste Schritte…"></textarea>
          </label>
        </div>
      </div>

      <div class="hr"></div>

      <details class="noPrint" open>
        <summary>Honorarnote (pro Fall)</summary>
        <div style="height:10px"></div>

        <div class="two">
          <div class="row">
            <label>Rechnungsnummer
              <input id="invNo" placeholder="wird automatisch vergeben"/>
            </label>
            <label>Rechnungsdatum
              <input id="invDate" type="date"/>
            </label>
            <label>Leistungsdatum
              <input id="invServiceDate" type="date"/>
            </label>
            <label>Leistung
              <input id="invService" placeholder="z.B. Diagnostik (DSDS/DTIM), Auswertung, Befund"/>
            </label>
          </div>

          <div class="row">
            <label>Einheiten (z.B. 1, 1.5)
              <input id="invUnits" type="number" step="0.25" min="0"/>
            </label>
            <label>Tarif pro Einheit (€)
              <input id="invRate" type="number" step="0.5" min="0"/>
            </label>
            <label>USt-Hinweis (optional)
              <input id="invTaxNote" placeholder="z.B. Umsatzsteuerfrei gem. § 6 Abs. 1 Z 27 UStG"/>
            </label>
            <label>Zahlungsziel (Tage)
              <input id="invDueDays" type="number" step="1" min="0"/>
            </label>
          </div>
        </div>

        <div class="two">
          <div class="row">
            <label>Rechnung an (Name/Einrichtung)
              <input id="invBillTo" placeholder="z.B. Einrichtung / Klient:in"/>
            </label>
            <label>Adresse Empfänger:in (optional)
              <textarea id="invBillToAddr" placeholder="Straße, PLZ Ort…"></textarea>
            </label>
          </div>
          <div class="row">
            <label>Deine Daten (Absender)
              <textarea id="invFrom" placeholder="Name, Berufsbezeichnung, Adresse"></textarea>
            </label>
            <label>Bankverbindung (IBAN/BIC)
              <textarea id="invBank" placeholder="IBAN …&#10;BIC … (optional)"></textarea>
            </label>
          </div>
        </div>

        <div class="toolbar">
          <span class="muted">Gesamtbetrag wird automatisch berechnet.</span>
          <div class="btns">
            <button id="btnMakeInvoice" class="secondary" type="button">Honorarnote erzeugen</button>
            <button id="btnPrintInvoice" type="button">Honorarnote drucken/PDF</button>
          </div>
        </div>
      </details>

      <div class="hr"></div>

      <div class="row">
        <div class="toolbar">
          <span class="pill">Befund-Text (auto)</span>
          <span class="muted">Kannst du kopieren oder drucken.</span>
        </div>
        <textarea id="genText" readonly></textarea>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div class="toolbar">
          <span class="pill">Honorarnote (Text)</span>
          <span class="muted">Erzeugt über „Honorarnote erzeugen“.</span>
        </div>
        <textarea id="invoiceText" readonly></textarea>
      </div>
    </section>
  </div>
</main>

<script>
/** ------------------------------
 * Storage Model
 * ------------------------------
 * data = {
 *   version: 1,
 *   profile: { from, bank, taxNote, rate, dueDays },
 *   invoiceCounter: { year, seq },
 *   cases: [ {id, createdAt, updatedAt, ...fields } ]
 * }
 */
const STORAGE_KEY = "praxisAppData_v1";



const PIN_KEY = "praxisAppPin_v1"; // {saltB64, hashB64, iterations}

function bufToB64(buf){
  const bytes = new Uint8Array(buf);
  let bin = "";
  for (let i=0;i<bytes.length;i++) bin += String.fromCharCode(bytes[i]);
  return btoa(bin);
}
function b64ToBuf(b64){
  const bin = atob(b64);
  const bytes = new Uint8Array(bin.length);
  for (let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
  return bytes.buffer;
}
async function pbkdf2Hash(pin, saltBuf, iterations){
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey(
    "raw", enc.encode(pin), {name:"PBKDF2"}, false, ["deriveBits"]
  );
  const bits = await crypto.subtle.deriveBits(
    {name:"PBKDF2", hash:"SHA-256", salt: saltBuf, iterations: iterations},
    keyMaterial,
    256
  );
  return bits;
}
function getPinRecord(){
  try{
    const raw = localStorage.getItem(PIN_KEY);
    return raw ? JSON.parse(raw) : null;
  }catch{ return null; }
}
function setPinRecord(rec){
  localStorage.setItem(PIN_KEY, JSON.stringify(rec));
}
function setAppLocked(locked){
  const el = $("lockOverlay");
  el.style.display = locked ? "flex" : "none";
}
function showLockUI(){
  const rec = getPinRecord();
  const hasPin = !!(rec && rec.saltB64 && rec.hashB64);
  $("lockCreate").style.display = hasPin ? "none" : "block";
  $("lockEnter").style.display  = hasPin ? "block" : "none";
  $("lockError").style.display  = "none";
  $("pinEnter").value = "";
  $("pinNew1").value = "";
  $("pinNew2").value = "";
  setAppLocked(true);
  setTimeout(()=> (hasPin ? $("pinEnter") : $("pinNew1")).focus(), 50);
}
async function ensureUnlocked(){
  showLockUI();
  return await new Promise((resolve) => {
    $("btnSetPin").onclick = async () => {
      const p1 = ($("pinNew1").value || "").trim();
      const p2 = ($("pinNew2").value || "").trim();
      if(p1.length < 4){ alert("PIN zu kurz (mind. 4 Ziffern)."); return; }
      if(p1 !== p2){ alert("PIN stimmt nicht überein."); return; }
      const salt = crypto.getRandomValues(new Uint8Array(16)).buffer;
      const iterations = 120000;
      const hash = await pbkdf2Hash(p1, salt, iterations);
      setPinRecord({saltB64: bufToB64(salt), hashB64: bufToB64(hash), iterations});
      alert("PIN gespeichert. Bitte jetzt entsperren.");
      showLockUI();
    };
    $("btnUnlock").onclick = async () => {
      const rec2 = getPinRecord();
      const pin = ($("pinEnter").value || "").trim();
      if(!rec2){ showLockUI(); return; }
      try{
        const salt = b64ToBuf(rec2.saltB64);
        const iterations = rec2.iterations || 120000;
        const hash = await pbkdf2Hash(pin, salt, iterations);
        const ok = (bufToB64(hash) === rec2.hashB64);
        if(!ok){
          const e = $("lockError");
          e.textContent = "Falscher PIN.";
          e.style.display = "block";
          return;
        }
        setAppLocked(false);
        resolve(true);
      }catch{
        const e = $("lockError");
        e.textContent = "Fehler beim Entsperren.";
        e.style.display = "block";
      }
    };
  });
}
function lockNow(){ showLockUI(); }

const $ = (id) => document.getElementById(id);
let currentId = null;

function uid(){
  return (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random()));
}
function todayISO(){
  const d = new Date();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${d.getFullYear()}-${mm}-${dd}`;
}
function loadData(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return defaultData();
    const d = JSON.parse(raw);
    return normalizeData(d);
  }catch{
    return defaultData();
  }
}
function saveData(d){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(d));
  $("storageStatus").textContent = "Lokal gespeichert ✓";
  $("storageStatus").classList.remove("bad");
}
function defaultData(){
  return normalizeData({
    version: 1,
    profile: {
      from: "",
      bank: "",
      taxNote: "Umsatzsteuerfrei gem. § 6 Abs. 1 Z 27 UStG (Kleinunternehmerregelung)",
      rate: 80,
      dueDays: 14
    },
    invoiceCounter: { year: new Date().getFullYear(), seq: 0 },
    cases: []
  });
}
function normalizeData(d){
  const nowY = new Date().getFullYear();
  if(!d || typeof d !== "object") return defaultData();
  d.version = 1;
  d.profile = d.profile && typeof d.profile === "object" ? d.profile : defaultData().profile;
  d.invoiceCounter = d.invoiceCounter && typeof d.invoiceCounter === "object" ? d.invoiceCounter : {year: nowY, seq: 0};
  if(d.invoiceCounter.year !== nowY){ d.invoiceCounter.year = nowY; d.invoiceCounter.seq = 0; }
  d.cases = Array.isArray(d.cases) ? d.cases : [];
  return d;
}
function nextInvoiceNo(data){
  const y = new Date().getFullYear();
  if(data.invoiceCounter.year !== y){ data.invoiceCounter.year = y; data.invoiceCounter.seq = 0; }
  data.invoiceCounter.seq += 1;
  return `${data.invoiceCounter.year}-${String(data.invoiceCounter.seq).padStart(4,"0")}`;
}
function formatMoney(n){
  const v = Math.round((Number(n||0)+Number.EPSILON)*100)/100;
  return v.toLocaleString("de-AT",{minimumFractionDigits:2,maximumFractionDigits:2});
}
function addDaysISO(iso, days){
  if(!iso) return "";
  const d = new Date(iso+"T00:00:00");
  d.setDate(d.getDate() + (Number(days)||0));
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${d.getFullYear()}-${mm}-${dd}`;
}
function safeFile(s){
  return String(s||"").toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-]/g,"").slice(0,40) || "backup";
}

function readForm(){
  return {
    clientName: $("clientName").value.trim(),
    dob: $("dob").value.trim(),
    date: $("date").value,
    setting: $("setting").value.trim(),
    question: $("question").value.trim(),
    methods: $("methods").value.trim(),
    dsds: $("dsds").value.trim(),
    dtim: $("dtim").value.trim(),
    summary: $("summary").value.trim(),
    reco: $("reco").value.trim(),
    invoice: {
      invNo: $("invNo").value.trim(),
      invDate: $("invDate").value,
      serviceDate: $("invServiceDate").value,
      service: $("invService").value.trim(),
      units: Number($("invUnits").value || 0),
      rate: Number($("invRate").value || 0),
      taxNote: $("invTaxNote").value.trim(),
      dueDays: Number($("invDueDays").value || 0),
      billTo: $("invBillTo").value.trim(),
      billToAddr: $("invBillToAddr").value.trim(),
      from: $("invFrom").value.trim(),
      bank: $("invBank").value.trim()
    },
    invoiceText: $("invoiceText").value
  };
}

function writeForm(c, data){
  $("clientName").value = c?.clientName || "";
  $("dob").value = c?.dob || "";
  $("date").value = c?.date || todayISO();
  $("setting").value = c?.setting || "";
  $("question").value = c?.question || "";
  $("methods").value = c?.methods || "";
  $("dsds").value = c?.dsds || "";
  $("dtim").value = c?.dtim || "";
  $("summary").value = c?.summary || "";
  $("reco").value = c?.reco || "";

  const prof = data.profile || defaultData().profile;
  const inv = c?.invoice || {};
  $("invNo").value = inv.invNo || "";
  $("invDate").value = inv.invDate || todayISO();
  $("invServiceDate").value = inv.serviceDate || ($("date").value || todayISO());
  $("invService").value = inv.service || "Psychologische Diagnostik (DSDS/DTIM), Auswertung und Befunderstellung";
  $("invUnits").value = (inv.units ?? 1);
  $("invRate").value = (inv.rate ?? prof.rate ?? 80);
  $("invTaxNote").value = (inv.taxNote ?? prof.taxNote ?? "");
  $("invDueDays").value = (inv.dueDays ?? prof.dueDays ?? 14);
  $("invBillTo").value = inv.billTo || "";
  $("invBillToAddr").value = inv.billToAddr || "";
  $("invFrom").value = inv.from ?? prof.from ?? "";
  $("invBank").value = inv.bank ?? prof.bank ?? "";
  $("invoiceText").value = c?.invoiceText || "";

  renderGenerated();
}

function buildBefundText(d){
  const lines = [];
  lines.push(`Befund – ${d.clientName || "—"} (Datum: ${d.date || "—"})`);
  if(d.setting) lines.push(`Setting/Kontext: ${d.setting}`);
  if(d.dob) lines.push(`Geburtsdatum: ${d.dob}`);
  lines.push("");

  if(d.question){ lines.push("Fragestellung/Anlass:"); lines.push(d.question); lines.push(""); }
  if(d.methods){ lines.push("Methoden:"); lines.push(d.methods); lines.push(""); }

  if(d.dsds || d.dtim){
    lines.push("Testergebnisse (Kurz):");
    if(d.dsds) lines.push(`DSDS: ${d.dsds}`);
    if(d.dtim) lines.push(`DTIM: ${d.dtim}`);
    lines.push("");
  }
  if(d.summary){ lines.push("Zusammenfassung:"); lines.push(d.summary); lines.push(""); }
  if(d.reco){ lines.push("Empfehlungen:"); lines.push(d.reco); lines.push(""); }

  return lines.join("\n").trim();
}
function renderGenerated(){
  $("genText").value = buildBefundText(readForm());
}

function renderList(){
  const data = loadData();
  const q = ($("search").value || "").toLowerCase().trim();
  const cases = data.cases.slice().sort((a,b)=>(b.updatedAt||"").localeCompare(a.updatedAt||""))
    .filter(c => !q || (`${c.clientName||""} ${c.date||""} ${c.setting||""} ${c.summary||""}`).toLowerCase().includes(q));

  const host = $("caseList");
  host.innerHTML = "";
  $("empty").style.display = cases.length ? "none" : "block";

  for(const c of cases){
    const el = document.createElement("div");
    el.className = "caseItem";
    el.innerHTML = `
      <strong>${(c.clientName||"(Ohne Name)").replace(/</g,"&lt;")}</strong>
      <div class="caseMeta">
        <span>Datum: ${c.date||"—"}</span>
        <span>${c.setting ? "• "+c.setting : ""}</span>
        <span>Update: ${(c.updatedAt||"").slice(0,16).replace("T"," ")}</span>
      </div>
      <div class="btns">
        <button class="secondary" data-act="open" type="button">Öffnen</button>
        <button class="ghost" data-act="exportOne" type="button">Export</button>
      </div>
    `;
    el.addEventListener("click",(e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      const act = btn.dataset.act;
      if(act==="open"){ openCase(c.id); }
      if(act==="exportOne"){ downloadJSON(c, `fall_${safeFile(c.clientName)}_${c.date||"datum"}.json`); }
    });
    host.appendChild(el);
  }
}

function openCase(id){
  const data = loadData();
  const c = data.cases.find(x=>x.id===id);
  if(!c) return;
  currentId = id;
  $("btnDelete").disabled = false;
  writeForm(c, data);
}

function newCase(){
  const data = loadData();
  currentId = null;
  $("btnDelete").disabled = true;
  writeForm({
    clientName:"",dob:"",date:todayISO(),setting:"",question:"",methods:"",dsds:"",dtim:"",summary:"",reco:"",
    invoice:{}, invoiceText:""
  }, data);
}

function saveCase(){
  const data = loadData();
  const form = readForm();
  const now = new Date().toISOString();

  if(currentId){
    const idx = data.cases.findIndex(c=>c.id===currentId);
    if(idx>=0){
      data.cases[idx] = { ...data.cases[idx], ...form, updatedAt: now };
    }else{
      data.cases.push({ id: currentId, createdAt: now, updatedAt: now, ...form });
    }
  }else{
    const id = uid();
    currentId = id;
    data.cases.push({ id, createdAt: now, updatedAt: now, ...form });
  }

  // keep invoice profile defaults up to date
  data.profile.from = form.invoice.from;
  data.profile.bank = form.invoice.bank;
  data.profile.taxNote = form.invoice.taxNote;
  data.profile.rate = form.invoice.rate;
  data.profile.dueDays = form.invoice.dueDays;

  saveData(data);
  $("btnDelete").disabled = false;
  renderList();
}

function deleteCase(){
  if(!currentId) return;
  const data = loadData();
  data.cases = data.cases.filter(c=>c.id!==currentId);
  saveData(data);
  newCase();
  renderList();
}

function deleteAll(){
  if(!confirm("Wirklich ALLES löschen (alle Fälle + Counter + Profil)?")) return;
  localStorage.removeItem(STORAGE_KEY);
  currentId = null;
  newCase();
  renderList();
}

function downloadJSON(obj, filename){
  const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}

function exportBackup(){
  const data = loadData();
  data.exportedAt = new Date().toISOString();
  downloadJSON(data, `praxis_backup_${new Date().toISOString().slice(0,10)}.json`);
}

function restoreBackup(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const parsed = JSON.parse(reader.result);
      const normalized = normalizeData(parsed);
      saveData(normalized);
      currentId = null;
      newCase();
      renderList();
      alert("Backup wiederhergestellt.");
    }catch(e){
      alert("Wiederherstellung fehlgeschlagen: " + (e?.message || "Fehler"));
      $("storageStatus").textContent = "Fehler beim Restore";
      $("storageStatus").classList.add("bad");
    }
  };
  reader.readAsText(file);
}

function makeInvoice(){
  const data = loadData();
  const form = readForm();
  const inv = form.invoice;

  if(!inv.invNo){
    inv.invNo = nextInvoiceNo(data);
    $("invNo").value = inv.invNo;
  }
  if(!inv.invDate){ inv.invDate = todayISO(); $("invDate").value = inv.invDate; }
  if(!inv.serviceDate){ inv.serviceDate = form.date || todayISO(); $("invServiceDate").value = inv.serviceDate; }

  const total = (Number(inv.units)||0) * (Number(inv.rate)||0);
  const dueDate = inv.dueDays ? addDaysISO(inv.invDate, inv.dueDays) : "";

  // persist profile
  data.profile.from = inv.from;
  data.profile.bank = inv.bank;
  data.profile.taxNote = inv.taxNote;
  data.profile.rate = inv.rate;
  data.profile.dueDays = inv.dueDays;

  const lines = [];
  lines.push("HONORARNOTE / RECHNUNG","");
  if(inv.from){ lines.push(inv.from,""); }

  lines.push(`Rechnungsnummer: ${inv.invNo}`);
  lines.push(`Rechnungsdatum: ${inv.invDate||""}`);
  lines.push(`Leistungsdatum: ${inv.serviceDate||""}`);
  lines.push("");

  lines.push("Rechnung an:");
  lines.push(inv.billTo || form.clientName || "—");
  if(inv.billToAddr) lines.push(inv.billToAddr);
  lines.push("");

  lines.push("Leistung:");
  lines.push(inv.service || "—");
  lines.push("");
  lines.push(`Menge/Einheiten: ${inv.units || 0}`);
  lines.push(`Tarif: € ${formatMoney(inv.rate || 0)} pro Einheit`);
  lines.push(`Gesamtbetrag: € ${formatMoney(total)}`);
  lines.push("");

  if(inv.taxNote){ lines.push(inv.taxNote, ""); }
  if(inv.dueDays){ lines.push(`Zahlungsziel: ${inv.dueDays} Tage` + (dueDate ? ` (fällig am ${dueDate})` : "")); }
  if(inv.bank){ lines.push("", "Bankverbindung:", inv.bank); }

  $("invoiceText").value = lines.join("\n").trim();

  // store counter/profile changes even ohne "Fall speichern"
  saveData(data);
}


function printOnlyText(title, text){
  // Minimales Druckfenster nur mit einem Textblock (z.B. Honorarnote)
  const safeTitle = (title || "Druck").replace(/</g,"&lt;");
  const body = (text || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  const w = window.open("", "_blank");
  if(!w){ alert("Pop-up blockiert. Bitte Pop-ups erlauben."); return; }
  w.document.open();
  w.document.write(`<!doctype html>
  <html lang="de"><head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>${safeTitle}</title>
    <style>
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;color:#111}
      h1{font-size:16px;margin:0 0 12px 0}
      pre{white-space:pre-wrap;word-wrap:break-word;border:1px solid #ddd;border-radius:12px;padding:14px;font-size:12.5px;line-height:1.35}
      @media print{body{margin:0} pre{border:none;border-radius:0;padding:0}}
    
    .lockOverlay{position:fixed;inset:0;background:rgba(3,7,18,.78);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;z-index:9999;padding:18px}
    .lockCard{width:min(520px,100%);background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px}
    .lockTitle{font-weight:900;font-size:16px}
    .lockSub{margin-top:6px;color:var(--muted);font-size:12px}
    .lockBtn{margin-top:12px;width:100%;border:0;border-radius:14px;padding:10px 12px;font-weight:900;color:white;background:var(--accent);cursor:pointer}
    .lockError{margin-top:10px;color:#fecaca;font-size:12px}
    .lockHint{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.35}

  </style>
  </head><body>
    <h1>${safeTitle}</h1>
    <pre>${body}</pre>
    <script>window.onload=()=>{window.focus();window.print();setTimeout(()=>window.close(),250);};</script>
  </body></html>`);
  w.document.close();
}

function wire(){
  const ids = ["clientName","dob","date","setting","question","methods","dsds","dtim","summary","reco",
               "invNo","invDate","invServiceDate","invService","invUnits","invRate","invTaxNote","invDueDays","invBillTo","invBillToAddr","invFrom","invBank"];
  for(const id of ids){
    $(id).addEventListener("input", ()=>{
      renderGenerated();
      $("storageStatus").textContent = "Nicht gespeichert…";
      $("storageStatus").classList.add("bad");
    });
  }

  $("btnNew").addEventListener("click", newCase);
  $("btnSave").addEventListener("click", saveCase);
  $("btnDelete").addEventListener("click", ()=>{ if(confirm("Diesen Fall wirklich löschen?")) deleteCase(); });
  $("btnDeleteAll").addEventListener("click", deleteAll);
  $("search").addEventListener("input", renderList);

  $("btnBackup").addEventListener("click", exportBackup);
  $("btnRestore").addEventListener("click", ()=> $("restoreFile").click());
  $("restoreFile").addEventListener("change", (e)=>{
    const f = e.target.files?.[0];
    if(f) restoreBackup(f);
    e.target.value = "";
  });

  $("btnPrint").addEventListener("click", ()=>window.print());
  $("btnLock").addEventListener("click", lockNow);

  $("btnCopy").addEventListener("click", async ()=>{
    try{ await navigator.clipboard.writeText($("genText").value); alert("Befund-Text kopiert."); }
    catch{ $("genText").select(); document.execCommand("copy"); alert("Befund-Text kopiert."); }
  });

  $("btnMakeInvoice").addEventListener("click", makeInvoice);
  $("btnPrintInvoice").addEventListener("click", ()=>{ if(!$("invoiceText").value.trim()) makeInvoice(); printOnlyText("Honorarnote / Rechnung", $("invoiceText").value); });
}

(async function init(){
  await ensureUnlocked();
  const data = loadData();
  $("date").value = todayISO();
  $("btnDelete").disabled = true;
  wire();
  newCase();
  renderList();
})();
</script>
</body>
</html>
